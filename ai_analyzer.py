from config import AI_TUNNEL_API_KEY
from openai import OpenAI
import logging

logger = logging.getLogger(__name__)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI API
client = OpenAI(api_key=AI_TUNNEL_API_KEY) if AI_TUNNEL_API_KEY else None

def analyze_changes_for_user(user_id: int, changes: dict) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ò–ò.
    """
    if not changes.get("changed"):
        return "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–∞–π—Ç–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ."

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    diff = changes.get("diff", [])
    changed_lines = len(diff)
    diff_preview = "\n".join(diff[:10])  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

    # –ï—Å–ª–∏ OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if not client:
        return (
            f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ:\n"
            f"üìù –ò–∑–º–µ–Ω–µ–Ω–æ —Å—Ç—Ä–æ–∫: {changed_lines}\n"
            f"üí° –§—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:\n{diff_preview[:500]}"
        )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
    prompt = (
        f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}:\n"
        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫: {changed_lines}\n"
        f"–§—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:\n{diff_preview[:1000]}\n\n"
        "–û–ø—Ä–µ–¥–µ–ª–∏ –≤–∞–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫—Ä–∞—Ç–∫–æ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
    )

    try:
        # –í—ã–∑—ã–≤–∞–µ–º OpenAI API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–∞–π—Ç–µ. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=200
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        return response.choices[0].message.content
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ OpenAI: {e}")
        # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —Å OpenAI, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        return (
            f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–∞–π—Ç–µ:\n"
            f"üìù –ò–∑–º–µ–Ω–µ–Ω–æ —Å—Ç—Ä–æ–∫: {changed_lines}\n"
            f"üí° –§—Ä–∞–≥–º–µ–Ω—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:\n{diff_preview[:500]}"
        )

def adapt_notifications(user_id: int, feedback: str) -> None:
    """
    –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (like/dislike).
    """
    if not client:
        logger.warning("OpenAI API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∞–¥–∞–ø—Ç–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è OpenAI
    prompt = (
        f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—Ü–µ–Ω–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ '{feedback}'. "
        "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π –±—É–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."
    )

    try:
        # –í—ã–∑—ã–≤–∞–µ–º OpenAI API –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
        client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "–¢—ã ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=100
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {e}")